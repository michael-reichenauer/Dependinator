@using Dependinator.Core
@inject ICanvasService srv
@inject ISnackbar snackbar
@inject ICloudSyncService cloudSyncService
@inject Dependinator.Models.IModelService modelService
@inject IApplicationEvents applicationEvents
@implements IDisposable

<MudMenu Icon="@Icons.Material.Outlined.Menu" IconColor="Color.Secondary" Dense="true" Class="@MenuClass"
         AnchorOrigin="Origin.BottomCenter">

    <MudMenuItem IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.Undo" Disabled="@(!modelService.CanUndo)"
                 OnClick="modelService.Undo">
        Undo
    </MudMenuItem>

    <MudMenuItem IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.Redo" Disabled="@(!modelService.CanRedo)"
                 OnClick="modelService.Redo">
        Redo
    </MudMenuItem>

    <MudMenuItem IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.FitScreen" OnClick="srv.PanZoomToFit">
        Fit to Screen
    </MudMenuItem>

    <MudMenuItem IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.Refresh" OnClick="srv.Refresh">
        Refresh
    </MudMenuItem>

    <MudDivider />

    <MudMenuItem IconColor="Color.Error" Icon="@Icons.Material.Outlined.DeveloperBoardOff" OnClick="@OnRemove">
        Reset Model
    </MudMenuItem>

    <MudDivider />
    @{
        string? currentPath = RecentModelPaths.Count > 0 ? RecentModelPaths[0] : null;
    }
    @foreach (var path in RecentModelPaths)
    {
        bool isCurrent = path == currentPath;
        <MudMenuItem IconColor="@(isCurrent ? Color.Secondary : Color.Default)" Icon="@Icons.Material.Outlined.Schema"
                     Style="@(isCurrent ? "color: var(--mud-palette-primary);" : null)" OnClick="() => srv.LoadAsync(path)">
            @Path.GetFileNameWithoutExtension(path)
        </MudMenuItem>
    }

    @if (cloudSyncService.IsAvailable)
    {
        <MudDivider />

        <MudMenuItem Disabled="true" Icon="@Icons.Material.Outlined.Cloud">
            @CloudStatusText
        </MudMenuItem>
        <MudMenuItem Disabled="true" Icon="@SyncStatusIcon">
            @SyncStatusText
        </MudMenuItem>

        @if (authState.IsAuthenticated)
        {
            <MudMenuItem IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.CloudUpload" OnClick="SyncUpAsync">
                Sync Up
            </MudMenuItem>
            <MudMenuItem IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.CloudDownload" OnClick="SyncDownAsync">
                Sync Down
            </MudMenuItem>
            <MudMenuItem IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.Logout" OnClick="LogoutAsync">
                Logout
            </MudMenuItem>
        }
        else
        {
            <MudMenuItem IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.Login" OnClick="LoginAsync">
                Login
            </MudMenuItem>
        }
    }

    <MudDivider />
    <MudMenuItem IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.Info" OnClick="@ShowAbout">
        About
    </MudMenuItem>

</MudMenu>

<MudMessageBox @ref="mbox" Title="Reset Model" CancelText="Cancel">
    <MessageContent>
        <MudText>Do you want to reset model?</MudText>
        <MudText Typo="Typo.body2">Note: Layout of all nodes and sub-nodes will be reset.</MudText>
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.DeveloperBoardOff">
            Reset
        </MudButton>
    </YesButton>
</MudMessageBox>

<MudMessageBox @ref="aboutBox" Title="About Dependinator" YesText="Close">
    <MessageContent>
        <MudText Typo="Typo.body1">Version: @Build.Version</MudText>
        <MudText Typo="Typo.body1">Commit: @Build.CommitSid</MudText>
        <MudText Typo="Typo.body1">Build Time: @Build.Time</MudText>
    </MessageContent>
</MudMessageBox>

<MudMessageBox @ref="syncDownBox" Title="Replace Local Cached Model" CancelText="Cancel">
    <MessageContent>
        <MudText>Download the cloud copy and overwrite the local cached model?</MudText>
        <MudText Typo="Typo.body2">The current local cached layout data will be replaced.</MudText>
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.CloudDownload">
            Replace
        </MudButton>
    </YesButton>
</MudMessageBox>

@code {
    Action? uiStateChangedHandler;
    MudMessageBox mbox { get; set; } = null!;
    MudMessageBox aboutBox { get; set; } = null!;
    MudMessageBox syncDownBox { get; set; } = null!;
    global::Shared.CloudAuthState authState = new(IsAvailable: false, IsAuthenticated: false, User: null);
    DateTimeOffset? lastSyncAt;
    string? lastSyncDirection;
    string? lastSyncSummary;

    IReadOnlyList<string> RecentModelPaths => srv.RecentModelPaths;
    string CloudStatusText =>
        authState.IsAuthenticated ? $"Cloud: signed in as {authState.User?.Email ?? authState.User?.UserId}" : "Cloud: not signed in";
    string SyncStatusText =>
        lastSyncAt is null
            ? "Sync: no sync this session"
            : $"Sync: {lastSyncDirection} {lastSyncAt.Value.LocalDateTime:t} - {lastSyncSummary}";
    string SyncStatusIcon => lastSyncDirection switch
    {
        "up" => Icons.Material.Outlined.CloudUpload,
        "down" => Icons.Material.Outlined.CloudDownload,
        "error" => Icons.Material.Outlined.CloudOff,
        _ => Icons.Material.Outlined.CloudQueue,
    };

    [Parameter]
    public string MenuClass { get; set; } = "ml-n3";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        uiStateChangedHandler = () => InvokeAsync(StateHasChanged);
        applicationEvents.UIStateChanged += uiStateChangedHandler;

        await RefreshAuthStateAsync();
    }

    async void OnRemove()
    {
        if (await mbox.ShowAsync() != true)
            return;

        srv.Remove();
    }

    async Task RefreshAuthStateAsync()
    {
        if (!cloudSyncService.IsAvailable)
            return;

        if (!Try(out var state, out var error, await cloudSyncService.GetAuthStateAsync()))
        {
            snackbar.Add(error.ErrorMessage, Severity.Warning);
            return;
        }

        authState = state;
    }

    async Task LoginAsync()
    {
        if (!Try(out var state, out var error, await cloudSyncService.LoginAsync()))
        {
            SetSyncStatus("error", "login failed");
            snackbar.Add(error.ErrorMessage, Severity.Error);
            return;
        }

        authState = state;
        if (authState.IsAuthenticated)
            SetSyncStatus("up", "ready");
    }

    async Task LogoutAsync()
    {
        if (!Try(out var state, out var error, await cloudSyncService.LogoutAsync()))
        {
            SetSyncStatus("error", "logout failed");
            snackbar.Add(error.ErrorMessage, Severity.Error);
            return;
        }

        authState = state;
        ClearSyncStatus();
    }

    async Task SyncUpAsync()
    {
        if (!Try(out var modelDto, out var error, modelService.GetCurrentModelDto()))
        {
            SetSyncStatus("error", "local model unavailable");
            snackbar.Add(error.ErrorMessage, Severity.Warning);
            return;
        }

        if (!Try(out var metadata, out var pushError, await cloudSyncService.PushAsync(modelService.ModelPath, modelDto)))
        {
            SetSyncStatus("error", "upload failed");
            snackbar.Add(pushError.ErrorMessage, Severity.Error);
            return;
        }

        SetSyncStatus("up", $"{Path.GetFileNameWithoutExtension(metadata.NormalizedPath)}");
        snackbar.Add($"Synced {metadata.CompressedSizeBytes} bytes to the cloud.", Severity.Success);
    }

    async Task SyncDownAsync()
    {
        if (await syncDownBox.ShowAsync() != true)
            return;

        if (string.IsNullOrWhiteSpace(modelService.ModelPath))
        {
            SetSyncStatus("error", "model not loaded");
            snackbar.Add("Model is not loaded.", Severity.Warning);
            return;
        }

        if (!Try(out var modelDto, out var error, await cloudSyncService.PullAsync(modelService.ModelPath)))
        {
            SetSyncStatus("error", "download failed");
            snackbar.Add(error.ErrorMessage, Severity.Error);
            return;
        }

        if (!Try(out var modelInfo, out var replaceError, await modelService.ReplaceCurrentModelAsync(modelDto)))
        {
            SetSyncStatus("error", "replace failed");
            snackbar.Add(replaceError.ErrorMessage, Severity.Error);
            return;
        }

        SetSyncStatus("down", Path.GetFileNameWithoutExtension(modelInfo.Path));
        snackbar.Add($"Loaded cloud model for {Path.GetFileNameWithoutExtension(modelInfo.Path)}.", Severity.Success);
    }

    public void Dispose()
    {
        if (uiStateChangedHandler is null)
            return;

        applicationEvents.UIStateChanged -= uiStateChangedHandler;
    }

    async Task ShowAbout()
    {
        await aboutBox.ShowAsync();
    }

    void SetSyncStatus(string direction, string summary)
    {
        lastSyncAt = DateTimeOffset.Now;
        lastSyncDirection = direction;
        lastSyncSummary = summary;
    }

    void ClearSyncStatus()
    {
        lastSyncAt = null;
        lastSyncDirection = null;
        lastSyncSummary = null;
    }
}
