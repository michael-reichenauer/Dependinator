@using DependinatorCore
@inject ICanvasService srv
@inject Dependinator.Models.IModelService modelService
@inject IApplicationEvents applicationEvents
@implements IDisposable

<MudMenu Icon="@Icons.Material.Outlined.Menu" IconColor="Color.Secondary" Dense="true" Class="@MenuClass"
         AnchorOrigin="Origin.BottomCenter">

    <MudMenuItem IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.Undo" Disabled="@(!modelService.CanUndo)"
                 OnClick="modelService.Undo">
        Undo
    </MudMenuItem>

    <MudMenuItem IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.Redo" Disabled="@(!modelService.CanRedo)"
                 OnClick="modelService.Redo">
        Redo
    </MudMenuItem>

    <MudMenuItem IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.FitScreen" OnClick="srv.PanZoomToFit">
        Fit to Screen
    </MudMenuItem>

    <MudMenuItem IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.Refresh" OnClick="srv.Refresh">
        Refresh
    </MudMenuItem>

    <MudDivider />

    <MudMenuItem IconColor="Color.Error" Icon="@Icons.Material.Outlined.DeveloperBoardOff" OnClick="@OnRemove">
        Reset Model
    </MudMenuItem>

    <MudDivider />
    @{
        string? currentPath = RecentModelPaths.Count > 0 ? RecentModelPaths[0] : null;
    }
    @foreach (var path in RecentModelPaths)
    {
        var isCurrent = path == currentPath;
        <MudMenuItem IconColor="@(isCurrent? Color.Secondary: Color.Default)" Icon="@Icons.Material.Outlined.Schema"
                     Style="@(isCurrent ? "color: var(--mud-palette-primary);" : null)" OnClick="() => srv.LoadAsync(path)">
            @Path.GetFileNameWithoutExtension(path)
        </MudMenuItem>
    }

    <MudDivider />
    <MudMenuItem IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.Info" OnClick="@ShowAbout">
        About
    </MudMenuItem>

</MudMenu>

<MudMessageBox @ref="mbox" Title="Reset Model" CancelText="Cancel">
    <MessageContent>
        <MudText>Do you want to reset model?</MudText>
        <MudText Typo="Typo.body2">Note: Layout of all nodes and sub-nodes will be reset.</MudText>
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.DeveloperBoardOff">
            Reset
        </MudButton>
    </YesButton>
</MudMessageBox>

<MudMessageBox @ref="aboutBox" Title="About Dependinator" YesText="Close">
    <MessageContent>
        <MudText Typo="Typo.body1">Version: @Build.Version</MudText>
        <MudText Typo="Typo.body1">Commit: @Build.CommitSid</MudText>
        <MudText Typo="Typo.body1">Build Time: @Build.Time</MudText>
    </MessageContent>
</MudMessageBox>

@code {
    private Action? uiStateChangedHandler;
    private MudMessageBox mbox { get; set; } = null!;
    private MudMessageBox aboutBox { get; set; } = null!;

    private IReadOnlyList<string> RecentModelPaths => srv.RecentModelPaths;

    [Parameter]
    public string MenuClass { get; set; } = "ml-n3";

    private async void OnRemove()
    {
        if (await mbox.ShowAsync() != true)
        {
            return;
        }

        srv.Remove();
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        uiStateChangedHandler = () => InvokeAsync(StateHasChanged);
        applicationEvents.UIStateChanged += uiStateChangedHandler;
    }

    public void Dispose()
    {
        if (uiStateChangedHandler is null)
        {
            return;
        }

        applicationEvents.UIStateChanged -= uiStateChangedHandler;
    }

    private async Task ShowAbout()
    {
        await aboutBox.ShowAsync();
    }
}