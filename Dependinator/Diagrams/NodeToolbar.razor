@using Dependinator.Diagrams.Dependencies
@using Dependinator.Diagrams.Icons
@using DependinatorCore
@using DependinatorCore.Parsing
@using DependinatorCore.Shared
@using MudBlazor

@if (HasSelectedLine)
{
  <MudButtonGroup Color="Color.Tertiary" Size="Size.Small" Variant="Variant.Filled" Class="mud-toolbar"
                  Style="@CssPosition">
    <MudMenu Icon="@MudBlazor.Icons.Material.Outlined.Menu" Dense="true" AnchorOrigin="Origin.BottomCenter">
      <MudMenuItem IconColor="Color.Secondary" Icon="@MudBlazor.Icons.Material.Outlined.TextSnippet"
                   OnClick="ShowProperties">
        Properties …
      </MudMenuItem>
      <MudMenuItem IconColor="Color.Secondary" Icon="@MudBlazor.Icons.Material.Outlined.FormatShapes"
                   OnClick="LayoutChildren">
        Reset Children Layout
      </MudMenuItem>
      <MudMenuItem IconColor="Color.Secondary" Icon="@MudBlazor.Icons.Material.Outlined.DeveloperBoardOff"
                   OnClick="LayoutDescendants">
        Reset All Descendants Layout
      </MudMenuItem>

      <MudDivider />
      @if (!IsNodeHidden)
      {
        <MudMenuItem IconColor="Color.Secondary" Icon="@MudBlazor.Icons.Material.Outlined.VisibilityOff"
                     OnClick="ToggleNodeHide" Disabled="@IsVisibilityDisabled">
          Hide Node …
        </MudMenuItem>
      }
      else
      {
        <MudMenuItem IconColor="Color.Secondary" Icon="@MudBlazor.Icons.Material.Outlined.Visibility"
                     OnClick="ToggleNodeHide" Disabled="@IsVisibilityDisabled">
          Show Node …
        </MudMenuItem>
      }
    </MudMenu>

    <MudIconButton Icon="@Icon.ReferencesIcon" OnClick="ShowReferences" />
    <MudIconButton Icon="@Icon.DependenciesIcon" OnClick="ShowDependencies" />
    <MudIconButton Icon="@MudBlazor.Icons.Material.Filled.CloseFullscreen"
                   OnClick="interactionService.DecreaseNodeSize" />
    <MudIconButton Icon="@MudBlazor.Icons.Material.Filled.OpenInFull" OnClick="interactionService.IncreaseNodeSize" />

    @if (CanShowSource)
    {
      <MudIconButton Icon="@MudBlazor.Icons.Material.Outlined.Code" OnClick="ShowSourceAsync" />
    }

    @if (!IsIconMode)
    {
      <MudToggleIconButton @bind-Toggled="interactionService.IsEditNodeMode" Icon="@MudBlazor.Icons.Material.Outlined.Edit"
                           ToggledIcon="@MudBlazor.Icons.Material.Filled.Edit" ToggledColor="@Color.Warning" />
      @if (interactionService.IsEditNodeMode)
      {
        <MudIconButton Icon="@MudBlazor.Icons.Material.Outlined.FitScreen" OnClick="interactionService.NodePanZoomToFit" />
      }

    }
  </MudButtonGroup>
}

<MudMessageBox @ref="mbox" Title="Reset Descendants" CancelText="Cancel">
  <MessageContent>
    Do you want to reset layout of all children and their descendants?
  </MessageContent>
  <YesButton>
    <MudButton Variant="Variant.Filled" Color="Color.Error"
               StartIcon="@MudBlazor.Icons.Material.Filled.DeveloperBoardOff">
      Reset
    </MudButton>
  </YesButton>
</MudMessageBox>


@code {
  const double ToolbarOffset = 58;
  private MudMessageBox mbox { get; set; } = null!;

  [Inject]
  IApplicationEvents applicationEvents { get; set; } = null!;

  [Inject]
  IInteractionService interactionService { get; set; } = null!;

  [Inject]
  ISelectionService selectionService { get; set; } = null!;

  [Inject]
  IDialogService dialogService { get; set; } = null!;

  [Inject]
  IDependenciesService dependenciesService { get; set; } = null!;

  [Inject]
  Models.IModelService modelService { get; set; } = null!;

  [Inject]
  INavigationService navigationService { get; set; } = null!;

  [Inject]
  IConfigService configService { get; set; } = null!;

  [Inject]
  IHost host { get; set; } = null!;

  bool IsVisibilityDisabled => selectionService.IsSelectedNodeParentHidden();
  bool IsNodeHidden => selectionService.IsSelectedNodeHidden();
  bool HasSelectedLine => selectionService.SelectedNodePosition != Models.Pos.None;
  bool IsIconMode => !interactionService.IsContainer;
  bool CanShowSource => interactionService.CanShowSource;

  string CssPosition =>
      $"position:fixed;left:{selectionService.SelectedNodePosition.X}px;"
      + $"top:{selectionService.SelectedNodePosition.Y - ToolbarOffset}px;";

  protected override void OnInitialized() => applicationEvents.UIStateChanged += OnUiStateChanged;

  void OnUiStateChanged() => InvokeAsync(StateHasChanged);

  public void Dispose() => applicationEvents.UIStateChanged -= OnUiStateChanged;

  void ShowProperties() =>
      dialogService.ShowAsync<NodeProperties>("Node Properties", new DialogOptions { CloseOnEscapeKey = true });

  async Task LayoutChildren()
  {
    if (!selectionService.SelectedId.IsNode)
      return;
    var nodeId = Models.NodeId.FromId(selectionService.SelectedId.Id);
    var isEdit = selectionService.IsEditMode;
    selectionService.Unselect();
    await modelService.LayoutNode(nodeId);
    selectionService.Select(nodeId);
    selectionService.SetEditMode(isEdit);
  }

  async Task LayoutDescendants()
  {
    if (!selectionService.SelectedId.IsNode)
      return;
    if (await mbox.ShowAsync() != true)
    {
      return;
    }
    var nodeId = Models.NodeId.FromId(selectionService.SelectedId.Id);
    var isEdit = selectionService.IsEditMode;
    selectionService.Unselect();
    await modelService.LayoutNode(nodeId, true);
    selectionService.Select(nodeId);
    selectionService.SetEditMode(isEdit);
  }

  async Task SetLayoutDensityAsync(Models.NodeLayoutDensity density)
  {
    Models.NodeLayout.SetDensity(density);
    await configService.SetAsync(config => config.LayoutDensity = density);
    applicationEvents.TriggerUIStateChanged();
  }

  string DensityIcon(Models.NodeLayoutDensity density) =>
      Models.NodeLayout.Density == density
          ? MudBlazor.Icons.Material.Filled.CheckCircle
          : MudBlazor.Icons.Material.Outlined.Circle;

  void ShowReferences() => dependenciesService.ShowReferences();

  void ShowDependencies() => dependenciesService.ShowDependencies();


  async Task ShowSourceAsync()
  {
    if (!selectionService.SelectedId.IsNode)
      return;

    string selectedId = selectionService.SelectedId.Id;
    var nodeId = Models.NodeId.FromId(selectedId);
    FileSpan? nodeFileSpan = null;

    string nodeTitle = selectedId;
    modelService.UseNode(
        selectedId,
        node =>
        {
          nodeTitle = node.LongName;
          nodeFileSpan = node.FileSpanOrParentSpan;
        }
    );
    if (nodeFileSpan is not null && host.IsVscExtWasm)
    {
      await navigationService.ShowEditor(Models.NodeId.FromId(selectionService.SelectedId.Id));
      return;
    }
    if (!Try(out var source, out var e, await modelService.GetSourceAsync(nodeId)))
    {
      await dialogService.ShowMessageBox("Source unavailable", e.ErrorMessage);
      return;
    }

    var parameters = new DialogParameters
    {
      [nameof(NodeSourceDialog.Source)] = source,
    };

    var options = new DialogOptions
    {
      CloseOnEscapeKey = true,
      FullWidth = true,
      MaxWidth = MaxWidth.ExtraLarge,
    };

    await dialogService.ShowAsync<NodeSourceDialog>(nodeTitle, parameters, options);
  }

  void ToggleNodeHide() => selectionService.ToggleNodeHide();
}