@using MudBlazor
@using Dependinator.Diagrams.Icons
@using Dependinator.Diagrams.Dependencies

@if (HasSelectedLine)
{
  <MudButtonGroup Color="Color.Tertiary" Size="Size.Small" Variant="Variant.Filled" Class="@($"mud-toolbar")"
                  Style="@CssPosition">
    <MudMenu Icon="@MudBlazor.Icons.Material.Outlined.Menu" Dense="true" AnchorOrigin="Origin.BottomCenter">
      <MudMenuItem IconColor="Color.Secondary" Icon="@MudBlazor.Icons.Material.Outlined.TextSnippet"
                   OnClick="ShowProperties">
        Properties …</MudMenuItem>
        <MudMenuItem IconColor="Color.Secondary" Icon="@MudBlazor.Icons.Material.Outlined.FormatShapes"
                     OnClick="ResetLayout">
          Reset Layout</MudMenuItem>
          @if (!IsNodeHidden)
          {
            <MudMenuItem IconColor="Color.Secondary" Icon="@MudBlazor.Icons.Material.Outlined.VisibilityOff"
                         OnClick="ToggleNodeHide" Disabled="@IsVisibilityDisabled">
              Hide Node …</MudMenuItem>
            }
      else
            {
              <MudMenuItem IconColor="Color.Secondary" Icon="@MudBlazor.Icons.Material.Outlined.Visibility"
                           OnClick="ToggleNodeHide" Disabled="@IsVisibilityDisabled">
                Show Node …</MudMenuItem>
              }
            </MudMenu>


            <MudIconButton Icon="@Icon.ReferencesIcon" OnClick="ShowReferences" />
            <MudIconButton Icon="@Icon.DependenciesIcon" OnClick="ShowDependencies" />
            @if (CanShowSource)
            {
              <MudIconButton Icon="@MudBlazor.Icons.Material.Outlined.Code" OnClick="ShowEditorAsync" />
            }

            @if (!IsIconMode)
            {
              <MudIconButton Icon="@MudBlazor.Icons.Material.Outlined.FitScreen" OnClick="interactionService.NodePanZoomToFit" />
              <MudToggleIconButton @bind-Toggled="interactionService.IsEditNodeMode" Icon="@MudBlazor.Icons.Material.Outlined.Edit"
                                   ToggledIcon="@MudBlazor.Icons.Material.Filled.Edit" ToggledColor="@Color.Warning" />
              <MudIconButton Icon="@MudBlazor.Icons.Material.Outlined.FormatShapes" OnClick="ResetLayout" />

            }
          </MudButtonGroup>
        }

@code {
  const double ToolbarOffset = 58;

  [Inject] IApplicationEvents applicationEvents { get; set; } = null!;
  [Inject] IInteractionService interactionService { get; set; } = null!;
  [Inject] ISelectionService selectionService { get; set; } = null!;
  [Inject] IDialogService dialogService { get; set; } = null!;
  [Inject] IDependenciesService dependenciesService { get; set; } = null!;
  [Inject] Models.IModelService modelService { get; set; } = null!;
  [Inject] INavigationService navigationService { get; set; } = null!;

  bool IsVisibilityDisabled => selectionService.IsSelectedNodeParentHidden();
  bool IsNodeHidden => selectionService.IsSelectedNodeHidden();
  bool HasSelectedLine => selectionService.SelectedNodePosition != Models.Pos.None;

  string CssPosition =>
  $"position:fixed;left:{selectionService.SelectedNodePosition.X}px;" +
  $"top:{selectionService.SelectedNodePosition.Y - ToolbarOffset}px;";
  bool IsIconMode => !interactionService.IsContainer;
  bool CanShowSource => interactionService.CanShowSource;

  protected override void OnInitialized() => applicationEvents.UIStateChanged += OnUiStateChanged;
  void OnUiStateChanged() => InvokeAsync(StateHasChanged);
  public void Dispose() => applicationEvents.UIStateChanged -= OnUiStateChanged;


  void ShowProperties() =>
  dialogService.ShowAsync<NodeProperties>("Node Properties",
  new DialogOptions { CloseOnEscapeKey = true });

  async Task ResetLayout()
  {
    if (!selectionService.SelectedId.IsNode)
      return;
    var nodeId = Models.NodeId.FromId(selectionService.SelectedId.Id);
    selectionService.Unselect();
    await modelService.ResetNodeLayout(nodeId);
  }

  void ShowReferences() => dependenciesService.ShowReferences();
  void ShowDependencies() => dependenciesService.ShowDependencies();

  async Task ShowEditorAsync()
  {
    if (!selectionService.SelectedId.IsNode)
      return;
    await navigationService.ShowEditor(Models.NodeId.FromId(selectionService.SelectedId.Id));
  }

  async Task ShowSourceAsync()
  {
    if (!selectionService.SelectedId.IsNode)
      return;

    string selectedId = selectionService.SelectedId.Id;
    var nodeId = Models.NodeId.FromId(selectedId);

    string nodeTitle = selectedId;
    modelService.UseNode(
    selectedId,
    node =>
    {
      nodeTitle = node.LongName;
    }
    );

    if (!Try(out var source, out var e, await modelService.GetSourceAsync(nodeId)))
    {
      await dialogService.ShowMessageBox("Source unavailable", e.ErrorMessage);
      return;
    }

    var parameters = new DialogParameters
    {
      [nameof(NodeSourceDialog.Source)] = source,
    };

    var options = new DialogOptions
    {
      CloseOnEscapeKey = true,
      FullWidth = true,
      MaxWidth = MaxWidth.ExtraLarge,
    };

    await dialogService.ShowAsync<NodeSourceDialog>(nodeTitle, parameters, options);
  }
  void ToggleNodeHide() => selectionService.ToggleNodeHide();
}