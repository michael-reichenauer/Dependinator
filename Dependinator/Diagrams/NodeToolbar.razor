@inject IApplicationEvents applicationEvents
@inject IInteractionService interactionService
@inject IDialogService DialogService


<MudButtonGroup Color="Color.Tertiary" Size="Size.Small" Variant="Variant.Filled"
    Style="@NodeToolBarPosition">
    <MudMenu Icon="@Icons.Material.Outlined.Menu" Dense="true" AnchorOrigin="Origin.BottomCenter">
        <MudMenuItem IconSize="Size.Medium" IconColor="Color.Secondary" Icon="@Icons.Material.Outlined.TextSnippet"
            OnClick="ShowProperties" OnTouch="ShowProperties">Properties ...</MudMenuItem>
    </MudMenu>
    
    <MudIconButton Icon="@Icons.Material.Filled.Polyline" OnClick="ToggleOpen"  />

    <MudIconButton Icon="@Icons.Material.Outlined.FitScreen" OnClick="interactionService.NodePanZoomToFit" Disabled="@isIcon"/>
    <MudToggleIconButton @bind-Toggled="@interactionService.IsEditNodeMode" Icon="@Icons.Material.Outlined.Edit" Disabled="@isIcon"
        ToggledIcon="@Icons.Material.Filled.Edit" ToggledColor="@Color.Warning" />
</MudButtonGroup>

<MudPopover Open="@_isOpen" Fixed="true" Class="px-4 pt-4" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.BottomLeft">
    <div class="d-flex flex-column">
        <MudText>Content of the popover can be anything.</MudText>
        <MudButton OnClick="@ToggleOpen" Class="ml-auto mr-n3 mb-1" Color="Color.Error">Close</MudButton>
    </div>
</MudPopover>

@code {
    bool isIcon => !interactionService.IsContainer;
    string NodeToolBarPosition => 
        $"Position: fixed; left:{interactionService.SelectedNodePosition.X}px; top:{interactionService.SelectedNodePosition.Y - 55}px";
  
    public bool _isOpen;

    public void ToggleOpen()
    {
        if (_isOpen)
            _isOpen = false;
        else
            _isOpen = true;
    }
    private void ShowProperties()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        DialogService.Show<NodeProperties>("Node Properties", options);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (firstRender) applicationEvents.UIStateChanged += () => InvokeAsync(StateHasChanged);
    }
}